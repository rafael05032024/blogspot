<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css"
    integrity="sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V" crossorigin="anonymous" />
  <link rel="stylesheet" href="style.css">

  <title>Blogspot</title>
</head>

<body>
  <main>
    <header>
      <div class="counters">
        <div class="likes">
          <i class="fa fa-thumbs-up"></i>
          <span>34</span>
        </div>

        <div class="hearts">
          <i class="fa fa-heart"></i>
          <span>56</span>
        </div>

        <div class="new-post" style="color: #fff;">
          <input type="file" id="submit_inpt" style="display:none" onchange="loadFile(event)">
          <i class="fa fa-plus-square" id="submit_btn"></i>
        </div>
      </div>
    </header>

    <div class="posts" id="posts"></div>
  </main>

  <script>
    document.getElementById('submit_btn').addEventListener('click', () => {
      document.getElementById('submit_inpt').click();
    });

    const loadedPosts = localStorage.getItem('storage_posts');
    const posts = loadedPosts ? JSON.parse(loadedPosts) : [
      {
        id: 1,
        img: './assets/img/selfie001.jpg',
        created_at: '2024-03-30T16:00:34.031Z',
        like: false,
        heart: false
      },
      {
        id: 2,
        img: './assets/img/selfie002.jpg',
        created_at: '2024-03-30T16:10:34.031Z',
        like: false,
        heart: false
      }
    ];

    function storePosts() {
      localStorage.setItem(
        'storage_posts',
        JSON.stringify(posts)
      );
    }

    const getBase64FromUrl = async (url) => {
      const data = await fetch(url);
      const blob = await data.blob();

      return new Promise((resolve) => {
        const reader = new FileReader();

        reader.readAsDataURL(blob);
        reader.onloadend = () => {
          const base64data = reader.result;
          resolve(base64data);
        }
      });
    }

    function download(source) {
      const fileName = source.split('/').pop();
      const el = document.createElement("a");

      el.setAttribute("href", source);
      el.setAttribute("download", fileName);

      document.body.appendChild(el);

      el.click();
      el.remove();
    }

    function favorite(element, action) {
      const [, id] = element.id.split(`${action}-btn-`)
      const postIndex = posts.findIndex(p => p.id === Number(id));
      const favorited = !posts[postIndex][action];

      posts[postIndex][action] = favorited;

      storePosts();

      element.style.color = favorited
        ? (action === 'like' ? '#5564FF' : '#FC6565')
        : '#9E9E9E'

    }

    function loadPosts() {
      const mural = document.getElementById('posts');

      mural.innerHTML = '';

      posts
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .forEach((post) => {
          const str = `
        <div class="card" id="${post.id}">
          <div class="card-header">
          </div>

          <div class="card-body">
            <div class="background"></div>

            <div class="number-of-comments">
              <i class="fa fa-comment" aria-hidden="true"></i>
              <span>100</span>
            </div>

            <img src="${post.img}">
          </div>

          <div class="card-footer">
            <i class="fa fa-thumbs-up" id="like-btn-${post.id}" onclick="favorite(this, 'like')" style="color: ${post.like ? '#5564FF' : '#9E9E9E'};"></i>
            <i class="fa fa-heart" id="heart-btn-${post.id}" onclick="favorite(this, 'heart')" style="color: ${post.heart ? '#FC6565' : '#9E9E9E'};"></i>
            <i class="fa fa-download" onclick="download('${post.img}')"></i>
          </div>
        </div>
        `;

          const element = document.createElement('div');

          element.className = 'card'
          element.innerHTML = str;

          element.style.color =

            mural.appendChild(element);
        });
    }

    function loadFile(event) {
      const src = URL.createObjectURL(event.target.files[0]);
      const date = new Date();

      getBase64FromUrl(src).then((s) => {
        posts.push({
          id: date.getTime(),
          img: s,
          created_at: date.toISOString(),
          like: false,
          heart: false
        });

        storePosts();
        loadPosts();
      })
    };

    loadPosts();
  </script>
</body>

</html>